service: RPC-web-service # NOTE: update this with your service name

provider:
  name: aws
  runtime: python3.6
  stage: dev
  region: eu-west-1
  variableSyntax: '\${{([\s\S]+?)}}'

functions:
  hello:
    handler: handler.hello

resources:
 Resources:

  DynamoDBTableRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "dynamodb.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - 
          PolicyName: "DynamoFullAccess"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action: "dynamodb:*"
                Resource: "*"

      RoleName: DynamoDBTableRole
  
  ConnectedDevicesTable:
    Type: "AWS::DynamoDB::Table"
    DependsOn: ["DynamoDBTableRole"]
    Properties:
      AttributeDefinitions:
        - 
          AttributeName: "ID"
          AttributeType: "S"
      KeySchema:
        - 
          AttributeName: "ID"
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1    
      TableName: "ConnectedDevicesTable"

  DynamoDBTopicRule:
    Type: AWS::IoT::TopicRule
    DependsOn: ["ConnectedDevicesTable"]
    Properties:
      RuleName: DynamoDBTopicRule
      TopicRulePayload:
        RuleDisabled: false
        Sql: >-
          SELECT data.*
        Actions:
          - DynamoDBv2:
              PutItem:
                TableName: "ConnectedDevicesTable"
              RoleArn: !GetAtt DynamoDBTableRole.Arn
              